<!-- 我保证只在已验证时使用这个组件。服务器端UI渲染可以保证用户没法自己调出这个组件。 -->

@using System.Security.Cryptography
@using VirtualList.Datas
@using VirtualList.Helpers

@inject MainDbContext mainDb
@inject ILoggerFactory loggerFactory

<div style="position:fixed; margin: 0%; width: 100%; height: 100%; background: #00000070; z-index: 10;"></div>

<!-- CSS Margin 上右下左，为啥这么定义的 我不知道。 -->
<FluentCard Style="position: fixed; width: auto; height: auto; margin: 100px auto auto 100px; z-index: 11;">
    <FluentStack Orientation="Orientation.Vertical">
        <h3>新建用户</h3>
        <span>用户名：</span>
        <FluentTextField @bind-Value="userName" />
        <span>密码：</span>
        <FluentTextField @bind-Value="password" TextFieldType="TextFieldType.Password" />
        <span>确认密码：</span>
        <FluentTextField @bind-Value="confirmPassword" TextFieldType="TextFieldType.Password" />
        @if(!string.IsNullOrEmpty(errorMessage))
        {
            <p style="color: red">@errorMessage</p>
        }
        <FluentStack Style="display: block;" Orientation="Orientation.Horizontal">
            <FluentButton Style="float: right; margin: 5px;" OnClick="async () => await OnClose.InvokeAsync()">取消</FluentButton>
            <FluentButton Style="float: right; margin: 5px;" OnClick="AddUser" Appearance="Appearance.Accent">确认</FluentButton>
        </FluentStack>
    </FluentStack>
</FluentCard>

@code {
    [Parameter]
    public EventCallback OnClose { get; set; }

    string userName = "", password = "", confirmPassword = "", errorMessage = "";
    ILogger logger;

    protected override void OnInitialized()
    {
        logger = loggerFactory.CreateLogger("新建用户");
        base.OnInitialized();
    }

    async Task AddUser()
    {
        if(string.IsNullOrEmpty(userName))
        {
            errorMessage = "用户名为空！";
            return;
        }
        if(string.IsNullOrEmpty(password))
        {
            errorMessage = "密码为空！";
            return;
        }
        if(password != confirmPassword)
        {
            errorMessage = "两次输入的密码不一致！";
            return;
        }
        if(mainDb.Users.Any(ui => ui.Name == userName))
        {
            errorMessage = "用户名重复！";
            return;
        }
        byte[] salt = new byte[16];
        using(var rng = RandomNumberGenerator.Create())
        {
            rng.GetBytes(salt);
        }
        var userInfo = new UserInfo()
            {
                Name = userName,
                PasswordSalt = salt,
                PasswordHash = PasswordHelper.HashPassword(salt, password),
                CreatedTime = DateTime.Now,
                LastLogin = DateTime.Now
            };
        mainDb.Users.Add(userInfo);
        mainDb.SaveChanges();
        logger.LogInformation($"新建了用户{userName}");
        await OnClose.InvokeAsync();
    }
}
